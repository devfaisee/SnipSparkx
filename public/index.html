<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipSparkx — CSS Snippets</title>
  <link rel="stylesheet" href="/style.css" />
  <!-- Highlight.js for code styling -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <h1>SnipSparkx</h1>
        <p class="lead">Add, preview and copy CSS snippets — live preview powered by isolated iframes.</p>
      </div>
      <div class="header-controls">
        <input id="search" class="search" type="search" placeholder="Search snippets..." aria-label="Search snippets">
      </div>
    </div>
  </header>

  <main class="container">
    <section class="left">
      <div class="section-header">
        <h2>Snippets</h2>
        <p class="muted">Browse snippets or add your own. Tap a card to interact.</p>
      </div>
      <div id="snippets" class="snippets-list">
        <!-- snippets will be rendered here -->
      </div>
    </section>

    <aside class="right">
      <h2>Add Snippet</h2>
      <form id="addForm" class="snippet-form">
        <label>Title
          <input type="text" id="title" required />
        </label>
        <label>Description
          <input type="text" id="description" />
        </label>
        <label>CSS Code
          <textarea id="code" rows="9" placeholder="e.g. h1{ color: red; }" required></textarea>
        </label>
        <div class="form-actions">
          <button type="submit" class="btn primary">Add Snippet</button>
        </div>
        <div id="formMsg" class="form-msg" aria-live="polite"></div>
      </form>
    </aside>
  </main>

  <footer class="site-footer">
    <small>Built for quick CSS experimentation. Deploy to Vercel for serverless persistence.</small>
  </footer>

  <!-- Fullscreen modal preview -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-panel" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div id="modalTitle">Preview</div>
        <button id="modalClose" class="btn small">Close</button>
      </div>
      <iframe id="modalIframe" class="modal-iframe" sandbox="allow-same-origin"></iframe>
    </div>
  </div>

  <script>
  // Small OOP refactor: Snippet and SnippetManager classes
  class Snippet {
    constructor({id, title, description, code}){
      this.id = id;
      this.title = title || 'Untitled';
      this.description = description || '';
      this.code = code || '';
    }

    getSrcDoc(){
      const titleEsc = this._esc(this.title);
      const descEsc = this._esc(this.description);
      return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:Inter,system-ui,Arial;margin:12px;color:#111} .demo h1{margin:0 0 8px 0}${this.code}</style></head><body><div class="demo"><h1>${titleEsc}</h1><p>${descEsc}</p></div></body></html>`;
    }

    _esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    renderCard(onPreview){
      const card = document.createElement('article');
      card.className = 'card snippet-card';

      const titleEl = document.createElement('h3');
      titleEl.textContent = this.title;
      card.appendChild(titleEl);

      const desc = document.createElement('p');
      desc.className = 'desc';
      desc.textContent = this.description;
      card.appendChild(desc);

      const codeWrap = document.createElement('div');
      codeWrap.className = 'code-wrap';
      const pre = document.createElement('pre');
      pre.className = 'code';
      const codeEl = document.createElement('code');
      codeEl.textContent = this.code;
      codeEl.className = 'language-css';
      pre.appendChild(codeEl);
      codeWrap.appendChild(pre);

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn small';
      copyBtn.title = 'Copy CSS to clipboard';
      copyBtn.innerHTML = 'Copy';
      copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(this.code); copyBtn.textContent = 'Copied'; setTimeout(()=> copyBtn.innerHTML = 'Copy',1500);}catch(e){alert('Copy failed');}
      });
      codeWrap.appendChild(copyBtn);
      card.appendChild(codeWrap);

      const previewLabel = document.createElement('div');
      previewLabel.className = 'preview-label';
      previewLabel.textContent = 'Live Preview';
      card.appendChild(previewLabel);

      const iframe = document.createElement('iframe');
      iframe.className = 'preview-iframe';
      iframe.setAttribute('sandbox','allow-same-origin');
      iframe.srcdoc = this.getSrcDoc();
      card.appendChild(iframe);

      const actions = document.createElement('div');
      actions.className = 'card-actions';
      const previewBtn = document.createElement('button');
      previewBtn.className = 'btn small';
      previewBtn.textContent = 'Preview';
      previewBtn.addEventListener('click', ()=> onPreview(this.getSrcDoc(), this.title));
      actions.appendChild(previewBtn);

      const copyAction = copyBtn.cloneNode(true);
      copyAction.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(this.code); copyAction.textContent = 'Copied'; setTimeout(()=> copyAction.innerHTML = 'Copy',1500);}catch(e){alert('Copy failed');}});
      actions.appendChild(copyAction);
      card.appendChild(actions);

      if (window.hljs && hljs.highlightElement) {
        setTimeout(()=>{ try{ hljs.highlightElement(codeEl); }catch(e){} },10);
      }

      return card;
    }
  }

  class SnippetManager{
    constructor(){
      this.container = document.getElementById('snippets');
      this.modal = document.getElementById('modal');
      this.modalIframe = document.getElementById('modalIframe');
      this.modalTitle = document.getElementById('modalTitle');
      this.modalClose = document.getElementById('modalClose');
      this.modalBackdrop = document.getElementById('modalBackdrop');
      this.form = document.getElementById('addForm');
      this.msg = document.getElementById('formMsg');
      this.search = document.getElementById('search');
    }

    async init(){
      await this.renderSnippets();
      this._wireEvents();
    }

    async fetchSnippets(){
      const res = await fetch('/snippets.json');
      if(!res.ok) return [];
      return await res.json();
    }

    async renderSnippets(){
      this.container.innerHTML = '';
      const data = await this.fetchSnippets();
      if(!data || data.length === 0){ this.container.innerHTML = '<div class="empty">No snippets yet — add one on the right.</div>'; return; }
      (data||[]).slice().reverse().forEach(s=>{ const snippet = new Snippet(s); this.container.appendChild(snippet.renderCard(this.openModal.bind(this))); });
    }

    openModal(srcdoc, title){ this.modalIframe.srcdoc = srcdoc; this.modalTitle.textContent = title || 'Preview'; this.modal.setAttribute('aria-hidden','false'); this.modal.classList.add('open'); document.body.style.overflow = 'hidden'; }
    closeModal(){ this.modalIframe.srcdoc = ''; this.modal.setAttribute('aria-hidden','true'); this.modal.classList.remove('open'); document.body.style.overflow = ''; }

    _wireEvents(){
      if(this.modalClose) this.modalClose.addEventListener('click', ()=> this.closeModal());
      if(this.modalBackdrop) this.modalBackdrop.addEventListener('click', ()=> this.closeModal());

      if(this.search) this.search.addEventListener('input', (e)=>{
        const q = (e.target.value||'').toLowerCase().trim();
        const cards = document.querySelectorAll('.snippet-card');
        cards.forEach(c=>{ const t = (c.querySelector('h3')?.textContent||'').toLowerCase(); const d = (c.querySelector('.desc')?.textContent||'').toLowerCase(); c.style.display = (t.includes(q) || d.includes(q)) ? '' : 'none'; });
      });

      if(this.form) this.form.addEventListener('submit', async (ev)=>{
        ev.preventDefault(); this.msg.textContent=''; const title = document.getElementById('title').value.trim(); const description = document.getElementById('description').value.trim(); const code = document.getElementById('code').value; if(!title || !code){ this.msg.textContent = 'Please provide Title and CSS code.'; return; }
        try{ const res = await fetch('/api/addSnippet',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title,description,code}) }); if(!res.ok){ const err = await res.json().catch(()=>({error:'Unknown error'})); this.msg.textContent = 'Error: ' + (err.error || res.statusText); return; } const newSnippet = await res.json(); const sn = new Snippet(newSnippet); this.container.insertBefore(sn.renderCard(this.openModal.bind(this)), this.container.firstChild); this.form.reset(); this.msg.textContent = 'Snippet added.'; setTimeout(()=> this.msg.textContent = '',2500); }catch(e){ this.msg.textContent = 'Request failed.'; }
      });
    }
  }

  // Initialize manager
  document.addEventListener('DOMContentLoaded', ()=>{ const manager = new SnippetManager(); manager.init(); if(window.hljs && hljs.highlightAll){ try{ hljs.highlightAll(); }catch(e){} } });
  </script>
</body>
</html>
