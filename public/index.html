<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipSparkx — CSS Snippets</title>
  <link rel="stylesheet" href="/style.css" />
  <!-- Highlight.js for code styling -->
  <link rel="stylesheet" href="/vendor/atom-one-dark.min.css">
  <script src="/vendor/highlight.min.js"></script>
</head>
<body>
  <header class="bg-gradient-to-b from-slate-900 to-slate-800 text-slate-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">SnipSparkx</h1>
        <p class="text-slate-300 text-sm mt-1">Add, preview and copy CSS snippets — live previews in isolated sandboxes.</p>
      </div>
      <div class="w-full sm:w-80">
        <input id="search" class="w-full bg-slate-800/50 border border-slate-700 placeholder-slate-400 text-slate-100 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" type="search" placeholder="Search snippets..." aria-label="Search snippets">
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 md:grid-cols-3 gap-8">
    <section class="md:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-100">Snippets</h2>
          <p class="text-slate-300 text-sm">Browse snippets or preview them on mobile.</p>
        </div>
      </div>

      <div id="snippets" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- snippets will be rendered here -->
      </div>
    </section>

    <aside class="md:col-span-1">
      <div class="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 shadow-xl backdrop-blur">
        <h3 class="text-lg font-medium text-slate-100">Admin</h3>
        <p class="text-slate-300 text-sm mt-2">Snippets can only be added via the secure admin panel.</p>
        <div class="mt-4">
          <a href="/admin.html" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-b from-primary to-indigo-500 text-slate-900 rounded-lg shadow hover:scale-[1.02] transition">Open Admin Panel</a>
        </div>
        <p class="text-slate-400 text-xs mt-3">Visitors may preview and copy snippets only.</p>
      </div>
    </aside>
  </main>

  <footer class="text-center text-slate-400 text-sm py-6">Built for quick CSS experimentation. Deploy to Vercel for serverless persistence.</footer>

  <!-- Fullscreen modal preview -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50" aria-hidden="true">
    <div id="modalBackdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative z-10 w-full max-w-4xl mx-4">
      <div class="bg-slate-900 rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
        <div class="flex items-center justify-between px-4 py-2 border-b border-slate-700">
          <div id="modalTitle" class="text-slate-100 font-medium">Preview</div>
          <button id="modalClose" class="px-3 py-1 text-sm rounded bg-slate-800/60 text-slate-200">Close</button>
        </div>
        <iframe id="modalIframe" class="w-full h-[70vh] bg-white" sandbox="allow-scripts"></iframe>
      </div>
    </div>
  </div>

  <script>
  // Small OOP refactor: Snippet and SnippetManager classes
  class Snippet {
    constructor({id, title, description, code, html}){
      this.id = id;
      this.title = title || 'Untitled';
      this.description = description || '';
      this.code = code || '';
      this.html = html || '';
    }

    // Build the iframe srcdoc. If the snippet includes a full HTML document (doctype/html),
    // we insert the CSS into its head. Otherwise we wrap a small demo template.
    getSrcDoc(){
      const titleEsc = this._esc(this.title);
      const descEsc = this._esc(this.description);
      const hasFullHtml = /<!doctype\s+html>|<html[\s>]/i.test(this.html || '');

      // Basic client-side sanitization: remove script tags and "on..." attributes
      let userHtml = (this.html || '').toString();
      userHtml = userHtml.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
      userHtml = userHtml.replace(/\son[a-z]+\s*=\s*("[^"]*"|'[^']*'|[^\s>]+)/gi, '');
      // common typo/path fixes: styles.css -> style.css
      userHtml = userHtml.replace(/href=["']?\/styles\.css["']?/gi, 'href="/style.css"');
      userHtml = userHtml.replace(/href=["']?styles\.css["']?/gi, 'href="/style.css"');

      if(hasFullHtml){
        // Try to inject CSS into existing <head>
        const cssTag = `<style>body{font-family:Inter,system-ui,Arial;margin:12px;color:#111} .demo h1{margin:0 0 8px 0}${this.code}</style>`;
        if(/<head[\s\S]*?>/i.test(userHtml)){
          userHtml = userHtml.replace(/<\/head>/i, cssTag + '</head>');
        } else {
          // insert head after doctype
          userHtml = userHtml.replace(/<!doctype[^>]*>/i, match => match + `<head>${cssTag}</head>`);
        }
        return userHtml;
      }

      const demoHtml = userHtml.trim() ? userHtml : `<div class="demo"><h1>${titleEsc}</h1><p>${descEsc}</p><button class="btn primary">Example</button></div>`;
      return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:Inter,system-ui,Arial;margin:12px;color:#111} .demo h1{margin:0 0 8px 0}${this.code}</style></head><body>${demoHtml}</body></html>`;
    }

    _esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    renderCard(onPreview){
      const card = document.createElement('article');
      card.className = 'group flex flex-col h-[22rem] bg-slate-800/40 backdrop-blur border border-slate-700/50 rounded-xl overflow-hidden hover:border-primary/50 hover:shadow-xl hover:shadow-primary/10 transition-all duration-300 cursor-pointer snippet-card';
      card.onclick = () => onPreview(this);

      // 1. Live Preview Section (Fills most of the card)
      const previewContainer = document.createElement('div');
      previewContainer.className = 'relative flex-1 bg-slate-900/50 border-b border-slate-700/50 group-hover:border-primary/20 transition-colors overflow-hidden';
      
      const iframe = document.createElement('iframe');
      iframe.className = 'w-full h-full bg-white pointer-events-none'; // Immutable in card view
      iframe.setAttribute('sandbox','allow-scripts');
      iframe.setAttribute('loading','lazy');
      iframe.srcdoc = this.getSrcDoc();
      
      // Hover Overlay
      const overlay = document.createElement('div');
      overlay.className = 'absolute inset-0 bg-slate-900/20 backdrop-blur-[1px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center';
      overlay.innerHTML = '<span class="px-4 py-2 bg-slate-900/90 text-slate-100 text-sm font-medium rounded-full shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform">View Code & Preview</span>';

      previewContainer.appendChild(iframe);
      previewContainer.appendChild(overlay);
      card.appendChild(previewContainer);

      // 2. Content Section (Minimal Footer)
      const footer = document.createElement('div');
      footer.className = 'p-4 bg-slate-900/20 h-20 flex flex-col justify-center';

      const titleEl = document.createElement('h3');
      titleEl.textContent = this.title;
      titleEl.className = 'text-sm font-bold text-slate-200 truncate group-hover:text-primary transition-colors';
      
      const desc = document.createElement('p');
      desc.className = 'text-xs text-slate-400 mt-1 truncate';
      desc.textContent = this.description || 'No description';

      footer.appendChild(titleEl);
      footer.appendChild(desc);
      card.appendChild(footer);

      return card;
    }
  }

  class SnippetManager{
    constructor(){
      this.container = document.getElementById('snippets');
      this.modal = document.getElementById('modal');
      // We will rebuild the modal content dynamically
      this.modalContent = this.modal.querySelector('.relative.z-10'); 
      this.modalBackdrop = document.getElementById('modalBackdrop');
      this.modalClose = document.getElementById('modalClose');
      this.search = document.getElementById('search');
    }

    async init(){
      await this.renderSnippets();
      this._wireEvents();
    }

    async fetchSnippets(){
      const res = await fetch('/snippets.json');
      if(!res.ok) return [];
      return await res.json();
    }

    async renderSnippets(){
      this.container.innerHTML = '';
      const data = await this.fetchSnippets();
      if(!data || data.length === 0){ this.container.innerHTML = '<div class="empty">No snippets yet — add one on the right.</div>'; return; }
      (data||[]).slice().reverse().forEach(s=>{ const snippet = new Snippet(s); this.container.appendChild(snippet.renderCard(this.openModal.bind(this))); });
    }

    openModal(snippet){
      // Disable body scroll
      document.body.style.overflow = 'hidden';
      
      // Build Modal HTML Dynamically for "Professional" Split View
      const htmlCode = (snippet.html || '').replace(/</g,'&lt;');
      const cssCode = snippet.code;
      
      this.modalContent.innerHTML = `
        <div class="bg-slate-900 rounded-xl overflow-hidden border border-slate-700 shadow-2xl flex flex-col md:flex-row h-[85vh] w-full max-w-7xl mx-auto">
          <!-- Left: Preview -->
          <div class="w-full md:w-1/2 flex flex-col border-b md:border-b-0 md:border-r border-slate-700">
            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800/50">
               <h3 class="text-slate-100 font-medium truncate flex-1 mr-4">${snippet._esc(snippet.title)}</h3>
               <button id="modalCloseBtn" class="text-slate-400 hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="flex-1 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEgMWgydjJIMUMxeiIgZmlsbD0iIzIyMiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+')] bg-slate-950 relative">
              <iframe class="w-full h-full absolute inset-0 bg-white" sandbox="allow-scripts" srcdoc="${snippet.getSrcDoc().replace(/"/g,'&quot;')}"></iframe>
            </div>
          </div>

          <!-- Right: Code -->
          <div class="w-full md:w-1/2 flex flex-col bg-slate-900">
             <!-- Tabs -->
             <div class="flex items-center px-2 pt-2 gap-2 border-b border-slate-700 bg-slate-800/30">
                <button class="tab-btn px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary transition-colors" data-target="css-panel">CSS</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent transition-colors" data-target="html-panel">HTML</button>
                <div class="flex-1"></div>
                <button class="text-xs text-slate-400 hover:text-white mr-2" onclick="navigator.clipboard.writeText(this.getAttribute('data-code') === 'css' ? \`${cssCode.replace(/`/g,'\\`')}\` : \`${htmlCode.replace(/`/g,'\\`').replace(/&lt;/g,'<')}\`)">Copy Current</button>
             </div>

             <!-- Code Areas -->
             <div class="flex-1 overflow-hidden relative group">
                <div id="css-panel" class="code-panel h-full overflow-auto custom-scrollbar p-4">
                    <pre><code class="language-css text-sm font-mono leading-relaxed">${cssCode}</code></pre>
                </div>
                <div id="html-panel" class="code-panel h-full overflow-auto custom-scrollbar p-4 hidden">
                    <pre><code class="language-html text-sm font-mono leading-relaxed">${htmlCode || '&lt;!-- No HTML provided --&gt;'}</code></pre>
                </div>
             </div>
             
             <div class="p-4 border-t border-slate-700 bg-slate-800/20 text-xs text-slate-500">
                ${snippet._esc(snippet.description)}
             </div>
          </div>
        </div>
      `;

      this.modal.classList.remove('hidden');
      this.modal.classList.add('flex');
      
      // Wire up close button
      document.getElementById('modalCloseBtn').onclick = () => this.closeModal();

      // Wire up tabs
      const tabs = this.modalContent.querySelectorAll('.tab-btn');
      tabs.forEach(btn => {
          btn.onclick = () => {
              // Reset tabs
              tabs.forEach(t => { t.className = 'tab-btn px-4 py-2 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent transition-colors'; });
              // Activate clicked
              btn.className = 'tab-btn px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary transition-colors';
              
              // Toggle panels
              const target = btn.getAttribute('data-target');
              this.modalContent.querySelectorAll('.code-panel').forEach(p => p.classList.add('hidden'));
              document.getElementById(target).classList.remove('hidden');
          };
      });

      // Highlight syntax
      if(window.hljs) {
          this.modalContent.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
      }
    }

    closeModal(){
      this.modal.classList.add('hidden');
      this.modal.classList.remove('flex');
      this.modalContent.innerHTML = ''; // Clear to stop iframe
      document.body.style.overflow = '';
    }

    _wireEvents(){
      if(this.modalClose) this.modalClose.addEventListener('click', ()=> this.closeModal());
      if(this.modalBackdrop) this.modalBackdrop.addEventListener('click', ()=> this.closeModal());

      if(this.search) this.search.addEventListener('input', (e)=>{
        const q = (e.target.value||'').toLowerCase().trim();
        const cards = document.querySelectorAll('.snippet-card');
        cards.forEach(c=>{ const t = (c.querySelector('h3')?.textContent||'').toLowerCase(); const d = (c.querySelector('.desc')?.textContent||'').toLowerCase(); c.style.display = (t.includes(q) || d.includes(q)) ? '' : 'none'; });
      });

      if(this.form) this.form.addEventListener('submit', async (ev)=>{
        ev.preventDefault(); this.msg.textContent='';
        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();
        const code = document.getElementById('code').value;
        const html = document.getElementById('html') ? document.getElementById('html').value : '';
        if(!title || !code){ this.msg.textContent = 'Please provide Title and CSS code.'; return; }
        try{
          const res = await fetch('/api/addSnippet',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title,description,code,html}) });
          if(!res.ok){ const err = await res.json().catch(()=>({error:'Unknown error'})); this.msg.textContent = 'Error: ' + (err.error || res.statusText); return; }
          const newSnippet = await res.json(); const sn = new Snippet(newSnippet); this.container.insertBefore(sn.renderCard(this.openModal.bind(this)), this.container.firstChild); this.form.reset(); this.msg.textContent = 'Snippet added.'; setTimeout(()=> this.msg.textContent = '',2500);
        }catch(e){ this.msg.textContent = 'Request failed.'; }
      });
    }
  }

  // Initialize manager
  document.addEventListener('DOMContentLoaded', ()=>{ const manager = new SnippetManager(); manager.init(); if(window.hljs && hljs.highlightAll){ try{ hljs.highlightAll(); }catch(e){} } });
  </script>
</body>
</html>
