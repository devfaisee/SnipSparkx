<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipSparkx — CSS Snippets</title>
  <link rel="stylesheet" href="/style.css" />
  <!-- Highlight.js for code styling -->
  <link rel="stylesheet" href="/vendor/atom-one-dark.min.css">
  <script src="/vendor/highlight.min.js"></script>
</head>
<body>
  <header class="bg-gradient-to-b from-slate-900 to-slate-800 text-slate-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">SnipSparkx</h1>
        <p class="text-slate-300 text-sm mt-1">Add, preview and copy CSS snippets — live previews in isolated sandboxes.</p>
      </div>
      <div class="w-full sm:w-80">
        <input id="search" class="w-full bg-slate-800/50 border border-slate-700 placeholder-slate-400 text-slate-100 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" type="search" placeholder="Search snippets..." aria-label="Search snippets">
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 md:grid-cols-3 gap-8">
    <section class="md:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-100">Snippets</h2>
          <p class="text-slate-300 text-sm">Browse snippets or preview them on mobile.</p>
        </div>
      </div>

      <div id="snippets" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- snippets will be rendered here -->
      </div>
    </section>

    <aside class="md:col-span-1">
      <div class="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 shadow-xl backdrop-blur">
        <h3 class="text-lg font-medium text-slate-100">Admin</h3>
        <p class="text-slate-300 text-sm mt-2">Snippets can only be added via the secure admin panel.</p>
        <div class="mt-4">
          <a href="/admin.html" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-b from-primary to-indigo-500 text-slate-900 rounded-lg shadow hover:scale-[1.02] transition">Open Admin Panel</a>
        </div>
        <p class="text-slate-400 text-xs mt-3">Visitors may preview and copy snippets only.</p>
      </div>
    </aside>
  </main>

  <footer class="text-center text-slate-400 text-sm py-6">Built for quick CSS experimentation. Deploy to Vercel for serverless persistence.</footer>

  <!-- Fullscreen modal preview -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50" aria-hidden="true">
    <div id="modalBackdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative z-10 w-full max-w-4xl mx-4">
      <div class="bg-slate-900 rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
        <div class="flex items-center justify-between px-4 py-2 border-b border-slate-700">
          <div id="modalTitle" class="text-slate-100 font-medium">Preview</div>
          <button id="modalClose" class="px-3 py-1 text-sm rounded bg-slate-800/60 text-slate-200">Close</button>
        </div>
        <iframe id="modalIframe" class="w-full h-[70vh] bg-white" sandbox="allow-scripts"></iframe>
      </div>
    </div>
  </div>

  <script>
  // Small OOP refactor: Snippet and SnippetManager classes
  class Snippet {
    constructor({id, title, description, code, html}){
      this.id = id;
      this.title = title || 'Untitled';
      this.description = description || '';
      this.code = code || '';
      this.html = html || '';
    }

    // Build the iframe srcdoc. If the snippet includes a full HTML document (doctype/html),
    // we insert the CSS into its head. Otherwise we wrap a small demo template.
    getSrcDoc(){
      const titleEsc = this._esc(this.title);
      const descEsc = this._esc(this.description);
      const hasFullHtml = /<!doctype\s+html>|<html[\s>]/i.test(this.html || '');

      // Basic client-side sanitization: remove script tags and "on..." attributes
      let userHtml = (this.html || '').toString();
      userHtml = userHtml.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
      userHtml = userHtml.replace(/\son[a-z]+\s*=\s*("[^"]*"|'[^']*'|[^\s>]+)/gi, '');
      // common typo/path fixes: styles.css -> style.css
      userHtml = userHtml.replace(/href=["']?\/styles\.css["']?/gi, 'href="/style.css"');
      userHtml = userHtml.replace(/href=["']?styles\.css["']?/gi, 'href="/style.css"');

      if(hasFullHtml){
        // Try to inject CSS into existing <head>
        const cssTag = `<style>body{font-family:Inter,system-ui,Arial;margin:12px;color:#111} .demo h1{margin:0 0 8px 0}${this.code}</style>`;
        if(/<head[\s\S]*?>/i.test(userHtml)){
          userHtml = userHtml.replace(/<\/head>/i, cssTag + '</head>');
        } else {
          // insert head after doctype
          userHtml = userHtml.replace(/<!doctype[^>]*>/i, match => match + `<head>${cssTag}</head>`);
        }
        return userHtml;
      }

      const demoHtml = userHtml.trim() ? userHtml : `<div class="demo"><h1>${titleEsc}</h1><p>${descEsc}</p><button class="btn primary">Example</button></div>`;
      return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:Inter,system-ui,Arial;margin:12px;color:#111} .demo h1{margin:0 0 8px 0}${this.code}</style></head><body>${demoHtml}</body></html>`;
    }

    _esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    renderCard(onPreview){
      const card = document.createElement('article');
      card.className = 'bg-white/5 rounded-2xl p-5 border border-slate-700 shadow hover:-translate-y-2 transform transition';

      const titleEl = document.createElement('h3');
      titleEl.textContent = this.title;
      titleEl.className = 'text-slate-100 font-semibold';
      card.appendChild(titleEl);

      const desc = document.createElement('p');
      desc.className = 'text-slate-300 text-sm mt-2';
      desc.textContent = this.description;
      card.appendChild(desc);

      const pre = document.createElement('pre');
      pre.className = 'bg-slate-900 rounded-md mt-4 p-3 overflow-auto text-sm font-mono text-slate-100';
      const codeEl = document.createElement('code');
      codeEl.textContent = this.code;
      codeEl.className = 'language-css';
      pre.appendChild(codeEl);
      card.appendChild(pre);

      const iframe = document.createElement('iframe');
      iframe.className = 'w-full h-36 rounded-md mt-4 border border-slate-700 bg-white';
      iframe.setAttribute('sandbox','allow-scripts');
      iframe.srcdoc = this.getSrcDoc();
      card.appendChild(iframe);

      const actions = document.createElement('div');
      actions.className = 'flex items-center gap-3 mt-4';
      const previewBtn = document.createElement('button');
      previewBtn.className = 'px-3 py-1 bg-slate-800/60 text-slate-200 rounded';
      previewBtn.textContent = 'Preview';
      previewBtn.addEventListener('click', ()=> onPreview(this.getSrcDoc(), this.title));
      actions.appendChild(previewBtn);

      const copyBtn = document.createElement('button');
      copyBtn.className = 'px-3 py-1 bg-slate-800/40 text-slate-200 rounded';
      copyBtn.title = 'Copy CSS to clipboard';
      copyBtn.innerHTML = 'Copy';
      copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(this.code); copyBtn.textContent = 'Copied'; setTimeout(()=> copyBtn.innerHTML = 'Copy',1500);}catch(e){alert('Copy failed');}
      });
      actions.appendChild(copyBtn);

      card.appendChild(actions);

      if (window.hljs && hljs.highlightElement) {
        setTimeout(()=>{ try{ hljs.highlightElement(codeEl); }catch(e){} },10);
      }

      return card;
    }
  }

  class SnippetManager{
    constructor(){
      this.container = document.getElementById('snippets');
      this.modal = document.getElementById('modal');
      this.modalIframe = document.getElementById('modalIframe');
      this.modalTitle = document.getElementById('modalTitle');
      this.modalClose = document.getElementById('modalClose');
      this.modalBackdrop = document.getElementById('modalBackdrop');
      this.form = document.getElementById('addForm');
      this.msg = document.getElementById('formMsg');
      this.search = document.getElementById('search');
    }

    async init(){
      await this.renderSnippets();
      this._wireEvents();
    }

    async fetchSnippets(){
      const res = await fetch('/snippets.json');
      if(!res.ok) return [];
      return await res.json();
    }

    async renderSnippets(){
      this.container.innerHTML = '';
      const data = await this.fetchSnippets();
      if(!data || data.length === 0){ this.container.innerHTML = '<div class="empty">No snippets yet — add one on the right.</div>'; return; }
      (data||[]).slice().reverse().forEach(s=>{ const snippet = new Snippet(s); this.container.appendChild(snippet.renderCard(this.openModal.bind(this))); });
    }

    openModal(srcdoc, title){
      // set aria-hidden on main content to remove it from assistive tree
      const main = document.querySelector('main.container');
      if(main) main.setAttribute('aria-hidden','true');
      this.prevFocus = document.activeElement;
      this.modalIframe.srcdoc = srcdoc;
      this.modalTitle.textContent = title || 'Preview';
      this.modal.setAttribute('aria-hidden','false');
      this.modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      // focus close button for keyboard users
      setTimeout(()=>{ try{ this.modalClose.focus(); }catch(e){} },50);
    }

    closeModal(){
      this.modalIframe.srcdoc = '';
      this.modal.setAttribute('aria-hidden','true');
      this.modal.classList.add('hidden');
      document.body.style.overflow = '';
      const main = document.querySelector('main.container');
      if(main) main.removeAttribute('aria-hidden');
      try{ if(this.prevFocus && this.prevFocus.focus) this.prevFocus.focus(); }catch(e){}
    }

    _wireEvents(){
      if(this.modalClose) this.modalClose.addEventListener('click', ()=> this.closeModal());
      if(this.modalBackdrop) this.modalBackdrop.addEventListener('click', ()=> this.closeModal());

      if(this.search) this.search.addEventListener('input', (e)=>{
        const q = (e.target.value||'').toLowerCase().trim();
        const cards = document.querySelectorAll('.snippet-card');
        cards.forEach(c=>{ const t = (c.querySelector('h3')?.textContent||'').toLowerCase(); const d = (c.querySelector('.desc')?.textContent||'').toLowerCase(); c.style.display = (t.includes(q) || d.includes(q)) ? '' : 'none'; });
      });

      if(this.form) this.form.addEventListener('submit', async (ev)=>{
        ev.preventDefault(); this.msg.textContent='';
        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();
        const code = document.getElementById('code').value;
        const html = document.getElementById('html') ? document.getElementById('html').value : '';
        if(!title || !code){ this.msg.textContent = 'Please provide Title and CSS code.'; return; }
        try{
          const res = await fetch('/api/addSnippet',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title,description,code,html}) });
          if(!res.ok){ const err = await res.json().catch(()=>({error:'Unknown error'})); this.msg.textContent = 'Error: ' + (err.error || res.statusText); return; }
          const newSnippet = await res.json(); const sn = new Snippet(newSnippet); this.container.insertBefore(sn.renderCard(this.openModal.bind(this)), this.container.firstChild); this.form.reset(); this.msg.textContent = 'Snippet added.'; setTimeout(()=> this.msg.textContent = '',2500);
        }catch(e){ this.msg.textContent = 'Request failed.'; }
      });
    }
  }

  // Initialize manager
  document.addEventListener('DOMContentLoaded', ()=>{ const manager = new SnippetManager(); manager.init(); if(window.hljs && hljs.highlightAll){ try{ hljs.highlightAll(); }catch(e){} } });
  </script>
</body>
</html>
