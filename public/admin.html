<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipSparkx — Admin</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <main class="max-w-3xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-semibold text-slate-100 mb-4">SnipSparkx — Admin</h1>

    <section class="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 mb-6">
      <h2 class="text-lg font-medium text-slate-100">Login</h2>
      <p class="text-slate-300 text-sm mt-1">Sign in using the admin credentials configured in Vercel environment variables.</p>
      <form id="loginForm" class="mt-4 grid gap-3">
        <input id="loginUser" name="user" autocomplete="username" required class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-slate-100" placeholder="Username" />
        <input id="loginPass" name="pass" type="password" autocomplete="current-password" required class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-slate-100" placeholder="Password" />
        <div class="flex items-center gap-3">
          <button class="px-4 py-2 bg-gradient-to-b from-primary to-indigo-500 text-slate-900 rounded-lg" type="submit">Sign in</button>
          <div id="loginMsg" class="text-slate-300 text-sm"></div>
        </div>
      </form>
    </section>

    <section id="adminArea" class="hidden bg-slate-800/40 border border-slate-700 rounded-2xl p-6">
      <h2 class="text-lg font-medium text-slate-100">Create Snippet</h2>
      <p class="text-slate-300 text-sm mt-1">HTML and CSS are required. Preview before submit.</p>
      <form id="snippetForm" class="mt-4 grid gap-3">
        <input id="title" required class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-slate-100" placeholder="Title" />
        <input id="description" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-slate-100" placeholder="Description (optional)" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <textarea id="html" rows="6" required class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-slate-100" placeholder="HTML (full HTML allowed)"></textarea>
          <textarea id="code" rows="6" required class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-slate-100 font-mono" placeholder="CSS (styles for the snippet)"></textarea>
        </div>

        <div class="flex items-center gap-3 mt-2">
          <button class="px-4 py-2 bg-gradient-to-b from-primary to-indigo-500 text-slate-900 rounded-lg" type="submit">Add Snippet</button>
          <button type="button" id="previewBtn" class="px-3 py-2 bg-slate-800/40 rounded">Preview</button>
          <button type="button" id="logoutBtn" class="ml-auto px-3 py-2 bg-slate-700/40 rounded">Logout</button>
        </div>
      </form>

      <h3 class="text-sm font-medium text-slate-100 mt-4">Preview</h3>
      <iframe id="previewFrame" class="w-full h-60 rounded-md border border-slate-700 mt-2" sandbox="allow-same-origin allow-scripts"></iframe>

      <p id="adminMsg" class="text-slate-300 text-sm mt-3"></p>
    </section>
  </main>

  <script>
    // Minimal JWT helper to store token in localStorage and attach Authorization header
    const tokenKey = 'snip_admin_token';

    function setMsg(el, txt){ el.textContent = txt || ''; }

    function isLogged(){ return !!localStorage.getItem(tokenKey); }

    function showAdminArea(){ document.getElementById('adminArea').classList.remove('hidden'); }
    function hideAdminArea(){ document.getElementById('adminArea').classList.add('hidden'); }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg(document.getElementById('loginMsg'),'');
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;
      try{
        const res = await fetch('/api/admin/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ user, pass }) });
        const data = await res.json();
        if(res.ok && data && data.token){ localStorage.setItem(tokenKey, data.token); setMsg(document.getElementById('loginMsg'),'Signed in'); showAdminArea(); } else {
          setMsg(document.getElementById('loginMsg'), data && data.error ? data.error : 'Login failed');
        }
      }catch(err){ setMsg(document.getElementById('loginMsg'), String(err)); }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem(tokenKey); hideAdminArea(); setMsg(document.getElementById('loginMsg'),'Logged out'); });

    // Preview
    document.getElementById('previewBtn').addEventListener('click', ()=>{
      const html = document.getElementById('html').value || '';
      const css = document.getElementById('code').value || '';
      const src = `<!doctype html><html><head><meta charset="utf-8"><style>${css}</style></head><body>${html}</body></html>`;
      const frame = document.getElementById('previewFrame');
      frame.srcdoc = src;
    });

    // Submit snippet
    document.getElementById('snippetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const html = document.getElementById('html').value;
      const code = document.getElementById('code').value;
      const msgEl = document.getElementById('adminMsg');
      setMsg(msgEl,'');

      if(!title || !html || !code){ setMsg(msgEl,'Title, HTML and CSS are required.'); return; }

      const token = localStorage.getItem(tokenKey);
      try{
        const res = await fetch('/api/addSnippet', { method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization': token ? `Bearer ${token}` : '' }, body: JSON.stringify({ title, description, html, code }) });
        const data = await res.json();
        if(res.ok){ setMsg(msgEl,'Snippet added — id: ' + (data && data.id)); document.getElementById('snippetForm').reset(); document.getElementById('previewFrame').srcdoc = '' } else {
          setMsg(msgEl, data && data.error ? data.error : 'Failed to add snippet');
        }
      }catch(err){ setMsg(msgEl, String(err)); }
    });

    // Initialize UI
    (function(){ if(isLogged()) showAdminArea(); else hideAdminArea(); })();
  </script>
</body>
</html>
